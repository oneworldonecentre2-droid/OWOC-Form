<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>One World One Centre Student Intake Form</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

  <link href="https://cdn.jsdelivr.net/npm/tom-select/dist/css/tom-select.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/tom-select/dist/js/tom-select.complete.min.js"></script>

  <style>
    /* GLOBAL BOX SIZING FIX */
    *, *::before, *::after { box-sizing: border-box; }

    /* BASIC LAYOUT */
    body { margin: 0; border: 3px solid #C7631C; min-height: 100vh; background-color: white; }
    
    /* Wizard Container - Responsive Padding */
    .wizard { background-color: white; border-radius: 0.5rem; padding: 1.5rem; margin: 1rem auto; max-width: 1100px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    @media (min-width: 768px) { .wizard { padding: 2rem; margin: 2rem auto; } }

    .page { position: relative; min-height: 70vh; background-color: white; padding: 0.5rem; border-radius: 0.5rem; display: flex; flex-direction: column; justify-content: space-between; }
    .nav-buttons { display: flex; justify-content: space-between; margin-top: auto; padding-top: 1rem; }
    
    /* INPUT STYLES */
    select { transform-origin: top center !important; }
    .disabled-input { background:#f3f4f6; color:#6b7280; pointer-events: none; }
    
    /* =========================================
       STRICT YELLOW TABLE STYLING
       ========================================= */
    table.yellow-table {
        width: 100%;
        border-collapse: collapse; 
        border: 2px solid black; 
        font-size: 0.8rem;
        table-layout: fixed;
        min-width: 700px; /* Ensures table doesn't squash on mobile */
    }
    table.yellow-table td, table.yellow-table th { 
        border: 1px solid black; 
        padding: 4px 6px; 
        vertical-align: top;
        word-wrap: break-word;
        overflow-wrap: anywhere; 
    }
    
    /* Nested Tables */
    table.nested-table {
        width: 100%;
        border-collapse: collapse;
        margin: -1px; 
        width: calc(100% + 2px);
        table-layout: fixed;
    }
    table.nested-table td, table.nested-table th {
        border: 1px solid black !important;
        border-top: none !important;
        border-bottom: none !important;
    }
    
    /* Student Row Specifics */
    tr.student-row td { border-bottom: 1px solid black !important; }
    tr.student-row:last-child td { border-bottom: none !important; }
    
    /* Helper Classes */
    table.nested-table td:first-child, table.nested-table th:first-child { border-left: none !important; }
    table.nested-table td:last-child, table.nested-table th:last-child { border-right: none !important; }
    td.no-padding { padding: 0 !important; height: 100%; }

    /* Typography */
    .font-semibold { font-weight: 700; margin-bottom: 2px; font-size: 0.75rem; text-transform: uppercase; }
    .cell-content { width: 100%; min-height: 18px; word-break: break-word; overflow-wrap: anywhere; }

    /* PDF Print Specifics */
    #finalArea.pdf-scale { width: 100%; font-size: 10px !important; }
    
    /* Print Media Query */
    @media print {
        body { border: none; background-color: white; }
        .wizard, .nav-buttons, #editBtn, #printBtn, #pdfBtn, #newFormBtn, #orientationSelector { display: none !important; }
        #finalWrap { display: block !important; margin: 0; padding: 0; }
        #finalArea { border: none !important; box-shadow: none !important; width: 100%; background-color: white !important; }
        /* Force background color for print */
        #finalArea { -webkit-print-color-adjust: exact; print-color-adjust: exact; background-color: #fff989 !important; }
        /* Remove mobile scrolling for print */
        .overflow-x-auto { overflow: visible !important; }
    }

    /* Library Tweaks */
    .select2-container .select2-selection--single { height: 42px; border: 1px solid #d1d5db; padding: 6px; }
    .select2-container--default .select2-selection--single .select2-selection__arrow { height: 42px; top: 0; }
  </style>
</head>

<body class="bg-gray-100 text-gray-800">
  <div class="max-w-5xl mx-auto p-2 md:p-6">
    <div id="wizardRoot" class="wizard bg-white rounded-lg shadow">

    <div class="flex flex-col md:flex-row items-center justify-between gap-4">
      <h1 class="text-base md:text-lg font-semibold leading-tight text-center md:text-left">
        INFORMATION NEEDED FOR BOOKING APPOINTMENTS 
        <span class="whitespace-nowrap">and SENDING REQUESTS</span>
    </h1>
        <img src="One World Logo.jpg" alt="One World One Centre Logo" class="w-56 md:w-96 h-auto object-contain flex-shrink-0">
    </div>
    
    <hr class="border-t border-gray-200 my-4" />

      <section class="page" data-step="1">
     <h2 class="font-normal mb-6 text-base">Page 1</h2>

        
        <div class="grid grid-cols-12 gap-3">
          <div class="col-span-12 md:col-span-2">
            <label class="block text-sm">DATE</label>
            <input id="date" type="date" class="w-full border rounded p-2 mt-1" />
          </div>
          <div class="col-span-12 md:col-span-3">
            <label class="block text-sm">TAKEN BY</label>
            <input id="takenBy" type="text" class="w-full border rounded p-2 mt-1" />
          </div>
          <div class="col-span-12 md:col-span-4">
            <label class="block text-sm">CONTACT NAME / SURNAME</label>
            <input id="contactName" type="text" class="w-full border rounded p-2 mt-1" />
          </div>
          <div class="col-span-12 md:col-span-3">
            <label class="block text-sm">CONTACT PHONE #</label>
            <input id="contactPhone" type="text" maxlength="14" class="w-full border rounded p-2 mt-1" oninput="formatPhone(this)" />
          </div>
          <div class="col-span-12 md:col-span-4">
            <label class="block text-sm mt-2 md:mt-6">CONTACT RELATIONSHIP</label>
            <select id="contactRel" class="border rounded p-3 w-full" onchange="toggleOtherRelation(this)">
              <option value="" disabled selected hidden>-- Select --</option>
              <option value="Mother">Mother</option>
              <option value="Father">Father</option>
              <option value="Step-Mother">Step-Mother</option>
              <option value="Step-Father">Step-Father</option>
              <option value="Grandmother">Grandmother</option>
              <option value="Grandfather">Grandfather</option>
              <option value="Sister">Sister</option>
              <option value="Brother">Brother</option>
              <option value="Half-Sister">Half-Sister</option>
              <option value="Half-Brother">Half-Brother</option>
              <option value="Aunt">Aunt</option>
              <option value="Uncle">Uncle</option>
              <option value="Cousin">Cousin</option>
              <option value="Guardian">Guardian</option>
              <option value="Foster Parent">Foster Parent</option>
              <option value="Social Worker">Social Worker</option>
              <option value="Sponsor">Sponsor</option>
              <option value="Family Friend">Family Friend</option>
              <option value="Neighbor">Neighbor</option>
              <option value="Community Worker">Community Worker</option>
              <option value="Cousin">Relative</option>
              <option value="Other">Other</option>
            </select>
            <input type="text" id="otherRelation" class="border rounded p-2 w-full mt-2 hidden" placeholder="Specify" />
          </div>
        </div>
        <div class="nav-buttons justify-end">
          <button type="button" class="px-4 py-2 bg-green-700 text-white rounded hover:bg-green-800 transition" onclick="goTo(2)">Next</button>
        </div>
      </section>

      <section class="page hidden" data-step="2">
        <h2 class="font-normal mb-6 text-base">Page 2</h2>
        
        <div class="grid grid-cols-12 gap-3 mb-3">
          <div class="col-span-12 md:col-span-6">
            <label class="block text-sm">STUDENT'S STATUS</label>
            <div class="mt-1 flex flex-wrap gap-3">
  <label><input type="radio" name="studentStatus" value="PR" onchange="toggleOtherField('studentStatusOther', this)"> PR</label>
  <label><input type="radio" name="studentStatus" value="WP" onchange="toggleOtherField('studentStatusOther', this)"> WP</label>
  <label><input type="radio" name="studentStatus" value="SP" onchange="toggleOtherField('studentStatusOther', this)"> SP</label>
  <label><input type="radio" name="studentStatus" value="RC" onchange="toggleOtherField('studentStatusOther', this)"> RC</label>
  <label><input type="radio" name="studentStatus" value="Other" onchange="toggleOtherField('studentStatusOther', this)"> Other</label>
  <input id="studentStatusOther" type="text" class="hidden border rounded p-1 ml-2 w-32" placeholder="Specify" />
             
            </div>
          </div>
          <div class="col-span-12 md:col-span-6">
            <label class="block text-sm">IMMIGRATION DOC (PARENT/ GUARDIAN)</label>
<div class="mt-1 flex flex-wrap gap-3">
  <label><input type="radio" name="immDoc" value="PR" onchange="toggleOtherField('immDocOther', this)"> PR</label>
  <label><input type="radio" name="immDoc" value="WP" onchange="toggleOtherField('immDocOther', this)"> WP</label>
  <label><input type="radio" name="immDoc" value="SP" onchange="toggleOtherField('immDocOther', this)"> SP</label>
  <label><input type="radio" name="immDoc" value="RC" onchange="toggleOtherField('immDocOther', this)"> RC</label>
  <label><input type="radio" name="immDoc" value="Other" onchange="toggleOtherField('immDocOther', this)"> Other</label>
  <input id="immDocOther" type="text" class="hidden border rounded p-1 ml-2 w-32" placeholder="Specify" />
</div>
          </div>
          <div class="col-span-12 md:col-span-4 mt-2">
            <label class="block text-sm">EXPIRY DATE(RC/SP/WP)</label>
            <input id="expiry" type="date" class="w-full border rounded p-2 mt-1" />
          </div>
          <div class="col-span-12 mt-2">
            <label class="block text-sm">PREVIOUS ATTENDANCE IN CANADIAN SCHOOLS?</label>
            <div class="mt-1 flex gap-4">
              <label><input type="radio" name="prevAttend" value="No" onchange="toggleAttendance(false)"> No</label>
              <label><input type="radio" name="prevAttend" value="Yes" onchange="toggleAttendance(true)"> Yes</label>
            </div>
            <input id="prevDetails" type="text" class="mt-2 w-full border rounded p-2 disabled-input" placeholder="If Yes: Where / Grade / For how long" disabled />
          </div>
          <div class="col-span-12 md:col-span-4 mt-2">
            <label class="block text-sm">DATE STUDENT(S) LANDED IN CANADA</label>
            <input id="landed" type="date" class="w-full border rounded p-2 mt-1" />
          </div>
        </div>
        <div class="nav-buttons">
          <button type="button" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 transition" onclick="goTo(1)">Back</button>
          <button type="button" class="px-4 py-2 bg-green-700 text-white rounded hover:bg-green-800 transition" onclick="goTo(3)">Next</button>
        </div>
      </section>

      <section class="page hidden" data-step="3">
        <h2 class="font-normal mb-6 text-base">Page 3</h2>
        
        <div class="grid grid-cols-12 gap-3">
          <div class="col-span-12 md:col-span-3"><label class="block text-sm">FATHER'S SURNAME</label><input id="fatherSurname" type="text" class="w-full border rounded p-2 mt-1" /></div>
          <div class="col-span-12 md:col-span-3"><label class="block text-sm">FATHER'S GIVEN NAME</label><input id="fatherGiven" type="text" class="w-full border rounded p-2 mt-1" /></div>
          <div class="col-span-12 md:col-span-3"><label class="block text-sm">MOTHER'S SURNAME</label><input id="motherSurname" type="text" class="w-full border rounded p-2 mt-1" /></div>
          <div class="col-span-12 md:col-span-3"><label class="block text-sm">MOTHER'S GIVEN NAME</label><input id="motherGiven" type="text" class="w-full border rounded p-2 mt-1" /></div>
        </div>
        <div class="nav-buttons">
          <button type="button" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 transition" onclick="goTo(2)">Back</button>
          <button type="button" class="px-4 py-2 bg-green-700 text-white rounded hover:bg-green-800 transition" onclick="goTo(4)">Next</button>
        </div>
      </section>

      <section class="page hidden" data-step="4">
        <div>
            <h2 class="font-normal mb-6 text-base">Page 4</h2>
            
            <div class="grid grid-cols-12 gap-3">
              <div class="col-span-4 md:col-span-2">
                <label class="block text-sm">APT #</label>
                <input id="apt" type="text" class="w-full border rounded p-2 mt-1" />
              </div>
              <div class="col-span-8 md:col-span-8">
                <label class="block text-sm">FAMILY ADDRESS</label>
                <input id="address" type="text" class="w-full border rounded p-2 mt-1" />
              </div>
              <div class="col-span-12 md:col-span-2">
                <label class="block text-sm">POSTAL CODE</label>
                <input id="postal" type="text" class="w-full border rounded p-2 mt-1" oninput="enforcePostalFormat(this)" />
              </div>
              
              <div class="col-span-12 md:col-span-3 mt-2">
                <label class="block text-sm">FAMILY PHONE #</label>
                <input id="familyPhone" type="text" class="w-full border rounded p-2 mt-1" oninput="formatPhone(this)" />
              </div>
              <div class="col-span-12 md:col-span-6 mt-2">
                <label class="block text-sm">HOME LANGUAGE(S)</label>
                <select id="homeLang" multiple class="w-full border rounded p-2 mt-1"></select>
              </div>
              <div class="col-span-12 mt-2">
                <label class="block text-sm">CATHOLIC</label>
                <div class="flex gap-4">
                  <label><input type="radio" name="catholic" value="No"> No</label>
                  <label><input type="radio" name="catholic" value="Yes"> Yes</label>
                </div>
                <input id="religionOther" type="text" class="mt-2 w-full md:w-1/2 border rounded p-2" placeholder="Specify religion (Optional)" />
              </div>
            </div>
        </div>
        <div class="nav-buttons mt-4">
          <button type="button" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 transition" onclick="goTo(3)">Back</button>
          <button type="button" class="px-4 py-2 bg-green-700 text-white rounded hover:bg-green-800 transition" onclick="goTo(5)">Next</button>
        </div>
      </section>

      <section class="page hidden" data-step="5">
        <h2 class="font-normal mb-6 text-base">Page 5</h2>
        
        <div id="studentsContainer" class="space-y-4"></div>
        <div class="flex items-center gap-3 mt-3 flex-wrap">
          <button class="px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition" onclick="addStudent()" type="button">Add Student</button>
          <button class="px-3 py-2 bg-red-500 text-white rounded hover:bg-red-600 transition" onclick="removeStudent()" type="button">Remove Last</button>
        </div>
        <div class="nav-buttons">
          <button type="button" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 transition" onclick="goTo(4)">Back</button>
          <button type="button" class="px-4 py-2 bg-green-700 text-white rounded hover:bg-green-800 transition" onclick="goTo(6)">Next</button>
        </div>
      </section>

    <section class="page hidden" data-step="6">
        <h2 class="font-normal mb-6 text-base">Page 6</h2>

        <div class="grid grid-cols-12 gap-3">
            <div class="col-span-12">
                <label class="block text-sm">POTENTIAL LIMITED FORMAL SCHOOLING PROFILE</label>
                <div class="flex gap-4">
                    <label><input type="radio" name="limitedProfile" value="No" onchange="toggleLimitedProfile(false)"> No</label>
                    <label><input type="radio" name="limitedProfile" value="Yes" onchange="toggleLimitedProfile(true)"> Yes</label>
                </div>
            </div>
        </div>

        <div id="limitedProfileBox" class="col-span-12 mt-4 hidden">
            <label class="block text-sm font-medium">If YES, describe for each student, Grade 1–Grade 12, as relevant:</label>
            <p class="text-xs italic text-gray-600">
                Number of years as refugees, country of relocation, refugee camp name, nature of schooling, parent country of origin
            </p>
            <textarea id="limitedProfileDetails" class="w-full border rounded p-2 mt-2" placeholder="Provide details for each student"></textarea>
        </div>

        <div class="col-span-12 mt-4">
            <label class="block text-sm">NOTE:</label>
            <textarea id="notes" class="w-full border rounded p-2 mt-1" rows="3" placeholder="Additional notes if relevant"></textarea>
        </div>

        <div class="nav-buttons">
          <button class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 transition" onclick="goTo(5)">Back</button>
          <button class="px-4 py-2 bg-green-700 text-white rounded hover:bg-green-800 transition" onclick="generateFinal()">Generate Yellow Form</button>
        </div>
      </section>
    </div>

    <div id="finalWrap" class="final-wrap hidden mt-6">
      <div id="finalArea" class="p-4 md:p-6 rounded shadow border" style="background-color: #fff989;"></div>
      
      <div class="mt-4 flex flex-wrap justify-center gap-3 relative">
        <div id="orientationSelector" 
             class="absolute hidden bottom-full right-1/2 translate-x-1/2 mb-3 p-3 rounded shadow-xl z-20 text-sm" 
             style="background-color: #fff8dc; border: 1px solid #C7631C; width: 200px;">
            <p class="font-bold mb-2 text-gray-800">Select PDF Orientation:</p>
            <button id="downloadPortraitBtn" class="w-full mb-1 px-3 py-1 text-white rounded hover:opacity-90 transition" style="background-color: #C7631C;">Portrait (Taller)</button>
            <button id="downloadLandscapeBtn" class="w-full px-3 py-1 text-white rounded hover:opacity-90 transition" style="background-color: #C7631C;">Landscape (Wider)</button>
        </div>
        
        <button id="editBtn" class="px-4 py-2 bg-green-700 text-white rounded hover:bg-green-800">Back to Edit</button>
        <button id="printBtn" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700" onclick="window.print()">Print</button>
        <button id="pdfBtn" class="px-4 py-2 text-white rounded hover:opacity-90" style="background-color: #C7631C;">Download PDF</button>
        <button id="newFormBtn" class="px-4 py-2 bg-red-700 text-white rounded hover:bg-red-800">New Form</button>
      </div>
    </div>
  </div>

<script>

  
  // ============================================
  // 1. GLOBAL VARIABLES & UTILS
  // ============================================
  let currentStep = 1;
  let studentCount = 0;
  let countries = [];
  let countriesLoaded = false;
  const loadCountriesPromise = loadCountries(); 

  // HTML Escape Helper
  function escapeHtml(str) { 
    if (!str) return ''; 
    return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
  }

  function checkboxMark(cond){ return cond ? '☑' : '☐' }
  
  function getRadioValue(name){ 
    const r = document.querySelector(`input[name='${name}']:checked`); 
    return r ? r.value : ''; 
  }

  // Navigation
  function goTo(step){
    if (step < 1 || step > 6) return;
    document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
    const target = document.querySelector(`.page[data-step='${step}']`);
    if(target) {
        target.classList.remove('hidden');
        currentStep = step;
        window.scrollTo({top:0, behavior:'smooth'});
    }
  }

  // Toggles & Formatters
  function toggleOtherField(id, el){ 
    const inp = document.getElementById(id); 
    if(el.value === 'Other' && el.checked){ inp.classList.remove('hidden'); inp.focus(); } 
    else { inp.classList.add('hidden'); inp.value = ''; }
  }

  function toggleOtherRelation(select){
    const otherBox = document.getElementById('otherRelation');
    if(select.value === 'Other'){ otherBox.classList.remove('hidden'); otherBox.focus(); } 
    else { otherBox.classList.add('hidden'); otherBox.value = ''; }
  }

  function toggleAttendance(isYes){
    const d = document.getElementById('prevDetails');
    if(isYes){ d.disabled = false; d.classList.remove('disabled-input'); d.focus(); } 
    else { d.disabled = true; d.classList.add('disabled-input'); d.value = ''; }
  }

  function toggleLimitedProfile(isYes) {
    const box = document.getElementById('limitedProfileBox');
    if (isYes) { box.classList.remove('hidden'); } 
    else { box.classList.add('hidden'); document.getElementById('limitedProfileDetails').value = ''; }
  }

  function formatPhone(input) {
    let value = input.value.replace(/\D/g, '');
    if (value.length > 3 && value.length <= 6) { input.value = '(' + value.slice(0,3) + ') ' + value.slice(3); } 
    else if (value.length > 6) { input.value = '(' + value.slice(0,3) + ') ' + value.slice(3,6) + '-' + value.slice(6,10); } 
    else { input.value = value; }
  }

  function enforcePostalFormat(input) {
    let value = input.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
    let formatted = '';
    if (value.length > 0) formatted += value[0].replace(/[^A-Z]/g, '');
    if (value.length > 1) formatted += value[1].replace(/[^0-9]/g, '');
    if (value.length > 2) formatted += value[2].replace(/[^A-Z]/g, '');
    if (value.length > 3) formatted += ' ' + value[3].replace(/[^0-9]/g, '');
    if (value.length > 4) formatted += value[4].replace(/[^A-Z]/g, '');
    if (value.length > 5) formatted += value[5].replace(/[^0-9]/g, '');
    input.value = formatted;
  }





  
  // ============================================
  // 2. DATA LOADING (COUNTRIES & LANGS)
  // ============================================
  async function loadCountries(){
    try {
      const res = await fetch("https://restcountries.com/v3.1/all?fields=name");
      const data = await res.json();
      countries = data.map(c => c.name?.common).filter(Boolean).sort((a, b) => a.localeCompare(b));
    } catch(err){
      countries = ["Afghanistan","Canada","China","Eritrea","Ethiopia","India","Mexico","Philippines","Syria","Ukraine","United States","Vietnam","Other"];
    } finally { countriesLoaded = true; }
  }

  function populateCountrySelectById(selectEl, selectedValue){
    const $s = $(selectEl);
    $s.empty();
    $s.append($('<option disabled>').text('Select country').prop('selected', !selectedValue).prop('hidden', true));
    countries.forEach(c => $s.append($('<option>').val(c).text(c)));
    if($s.data('select2')) { $s.select2('destroy'); }
    // Responsive width for Select2
    $s.select2({ width: '100%', placeholder: "Search for a country", dropdownParent: $(document.body) });
    if(selectedValue) { $s.val(selectedValue).trigger('change'); }
  }

  function calculateGrade(dobString, startYear) {
    if (!dobString || !startYear) return "";
    const parts = dobString.split('-');
    if (parts.length !== 3) return "";
    
    const y = parseInt(parts[0], 10);
    const m = parseInt(parts[1], 10);
    const d = parseInt(parts[2], 10);
    const dob = new Date(y, m - 1, d);
    
    // --- 1. CALENDAR YEAR LOGIC (Jan 1 - Dec 31) ---
    if (y === startYear - 3) return "100 Voices (3YO)";
    if (y === startYear - 4) return "100 Voices (4YO)";
    if (y === startYear - 5) return "Kindergarten";
    if (y === startYear - 6) return "Grade 1";
    if (y === startYear - 7) return "Grade 2";

    // --- 2. MARCH 1ST CYCLE LOGIC (Grade 3+) ---
    // Helper: checks if date is between March 1 (StartYear) and Feb 28/29 (EndYear)
    function inRange(dateObj, yStart, yEnd) {
        const rangeStart = new Date(yStart, 2, 1); // March 1
        const rangeEnd = new Date(yEnd, 2, 0);     // Last day of Feb
        return dateObj >= rangeStart && dateObj <= rangeEnd;
    }

    if (inRange(dob, startYear - 8, startYear - 7)) return "Grade 3";
    if (inRange(dob, startYear - 9, startYear - 8)) return "Grade 4";
    if (inRange(dob, startYear - 10, startYear - 9)) return "Grade 5";
    if (inRange(dob, startYear - 11, startYear - 10)) return "Grade 6";
    if (inRange(dob, startYear - 12, startYear - 11)) return "Grade 7";
    if (inRange(dob, startYear - 13, startYear - 12)) return "Grade 8";
    if (inRange(dob, startYear - 14, startYear - 13)) return "Grade 9";
    if (inRange(dob, startYear - 15, startYear - 14)) return "Grade 10";
    if (inRange(dob, startYear - 16, startYear - 15)) return "Grade 11";
    if (inRange(dob, startYear - 17, startYear - 16)) return "Grade 12";
    
    // Post High School
    if (inRange(dob, startYear - 18, startYear - 17)) return "4th Year";
    if (inRange(dob, startYear - 19, startYear - 18)) return "5th Year";

    // Sixth Year (Sept 1 Start)
    const sixthStart = new Date(startYear - 20, 8, 1); // Sept 1
    const sixthEnd = new Date(startYear - 19, 2, 0);   // Feb End
    if (dob >= sixthStart && dob <= sixthEnd) return "6th Year";

    return "Check Date";
  }

  /**
   * Reads DOB and the selected 'School Year' radio button to calculate and display the grade.
   * @param {number} id - The student ID.
   */
  function updateGrade(id) {
    const dobInput = document.getElementById(`s_${id}_dob`);
    const gradeInput = document.getElementById(`s_${id}_calc_grade`);
    const yearRadios = document.getElementsByName(`s_${id}_year`);
    let selectedYearValue = '';

    yearRadios.forEach(radio => {
        if (radio.checked) {
            selectedYearValue = radio.value;
        }
    });

    if (dobInput && gradeInput && dobInput.value && selectedYearValue) {
        let targetStartYear = new Date().getFullYear();    
        if (selectedYearValue === 'ThisYear') {
            targetStartYear = 2025; 
        } else if (selectedYearValue === 'NextYear') {
            targetStartYear = 2026; 
        }

        gradeInput.value = calculateGrade(dobInput.value, targetStartYear);
    } else {
        gradeInput.value = '';
    }
  }

  // ============================================
// ============================================
// 3. STUDENT ROWS (Responsive)
// ============================================
function addStudent(prefill){
  studentCount++;
  const id = studentCount;
  const container = document.getElementById('studentsContainer');
  const wrap = document.createElement('div');
  wrap.className = 'p-4 border rounded bg-gray-50 mb-4';
  wrap.id = `student-${id}`;
  
  // REVISED HTML STRUCTURE: DOB and AGE APPR. GRADE moved to the second half.
  wrap.innerHTML = `
    <div class="grid grid-cols-12 gap-3">
      <div class="col-span-12 md:col-span-4">
          <label class="text-xs font-bold text-gray-700">STUDENT'S SURNAME</label>
          <input type="text" id="s_${id}_surname" class="w-full border rounded p-2 mt-1" value="${prefill?.surname||''}" />
      </div>
      <div class="col-span-12 md:col-span-4">
          <label class="text-xs font-bold text-gray-700">STUDENT'S GIVEN NAME</label>
          <input type="text" id="s_${id}_given" class="w-full border rounded p-2 mt-1" value="${prefill?.given||''}" />
      </div>
      <div class="col-span-12 md:col-span-4">
          <label class="text-xs font-bold text-gray-700">BIRTH COUNTRY</label>
          <select id="s_${id}_birth" class="country-select w-full border rounded p-2 mt-1"><option disabled selected>Loading...</option></select>
      </div>
    </div>

    <div class="grid grid-cols-12 gap-4 mt-3">
      
      <div class="col-span-6 md:col-span-3">
          <label class="text-xs font-bold text-gray-700">DOB</label>
          <input type="date" id="s_${id}_dob" class="w-full border rounded p-2 mt-1" value="${prefill?.dob||''}" onchange="updateGrade(${id})" />
      </div>
      
      <div class="col-span-6 md:col-span-4 overflow-visible">
          <label class="text-xs font-bold text-gray-700">LAST GRADE COMPLETED</label>
          <select id="s_${id}_lastgrade" class="w-full border rounded p-2 mt-1" onchange="toggleOtherGrade(${id})">
              <option value="" disabled selected hidden>Select grade</option>
              <option value="Pre KG">Pre KG</option>
              <option value="KG">KG</option>
              ${Array.from({length:12},(_,i)=>`<option value="Grade ${i+1}">Grade ${i+1}</option>`).join('')}
              <option value="Other">Other</option>
          </select>
          <input type="text" id="s_${id}_lastgrade_spec" class="w-full border rounded p-2 mt-1 hidden" placeholder="Specify grade" />
      </div>
      
      <div class="col-span-12 md:col-span-4">
          <label class="text-xs font-bold text-gray-700">PROGRAM</label>
          <div class="mt-1 p-2 border rounded bg-white">
              <div class="flex items-center gap-4">
                  <label class="inline-flex items-center"><input type="radio" name="s_${id}_progType" value="Regular" class="mr-2" onchange="toggleProgramDropdown(${id})">Regular</label>
                  <label class="inline-flex items-center"><input type="radio" name="s_${id}_progType" value="Special" class="mr-2" onchange="toggleProgramDropdown(${id})">Special</label>
              </div>
              <select id="s_${id}_prog_dropdown" class="w-full border rounded p-2 mt-2 hidden" onchange="toggleOtherProg(${id})">
                  <option value="" disabled selected hidden>Select program</option>
                  <option value="French Immersion">French Immersion</option>
                  <option value="Spanish Bilingual">Spanish Bilingual</option>
                  <option value="Ukrainian Bilingual">Ukrainian Bilingual</option>
                  <option value="Other">Other</option>
              </select>
              <input type="text" id="s_${id}_prog_spec" class="w-full border rounded p-2 mt-2 hidden" placeholder="Specify program" />
          </div>
      </div>
    </div>

    <div class="grid grid-cols-12 gap-4 mt-3">
      <div class="col-span-12 md:col-span-3">
          <label class="text-xs font-bold text-gray-700">GENDER</label>
          <div class="mt-1 flex items-center gap-6 p-2 border rounded bg-white">
              <label class="inline-flex items-center"><input type="radio" name="s_${id}_gender" value="F" class="mr-2">F</label>
              <label class="inline-flex items-center"><input type="radio" name="s_${id}_gender" value="M" class="mr-2">M</label>
          </div>
      </div>
      <div class="col-span-12 md:col-span-6">
          <label class="text-xs font-bold text-gray-700">SCHOOL YEAR</label>
          <div class="mt-1 flex items-center gap-6 p-2 border rounded bg-white">
              <label class="inline-flex items-center"><input type="radio" name="s_${id}_year" value="ThisYear" class="mr-2" onchange="updateGrade(${id})">This Year (2025–26)</label>
              <label class="inline-flex items-center"><input type="radio" name="s_${id}_year" value="NextYear" class="mr-2" onchange="updateGrade(${id})">Next year (2026-27)</label>
          </div>
      </div>
      
      <div class="col-span-12 md:col-span-3">
          <label class="text-xs font-bold text-gray-700 text-blue-700">AGE APPROPRIATE GRADE</label>
          <input type="text" id="s_${id}_calc_grade" class="w-full border rounded p-2 mt-1 bg-blue-50 font-bold text-blue-800" readonly tabindex="-1" placeholder="Auto" />
      </div>
    </div>`;
  
  container.appendChild(wrap);
  const selectEl = wrap.querySelector(`#s_${id}_birth`);
  
  // Init Country
  if (countriesLoaded) { populateCountrySelectById(selectEl, prefill?.birth || ''); } 
  else { loadCountriesPromise.then(()=> populateCountrySelectById(selectEl, prefill?.birth || '')); }
  
  // Trigger calc if prefill exists
  if (prefill?.dob) updateGrade(id);

  if(studentCount > 1) window.scrollTo({top:wrap.offsetTop-60, behavior:'smooth'});
}

  function removeStudent(){ if(studentCount===0)return; document.getElementById(`student-${studentCount}`)?.remove(); studentCount--; }
  function toggleOtherGrade(id){ const sel=document.getElementById(`s_${id}_lastgrade`); const spec=document.getElementById(`s_${id}_lastgrade_spec`); if(sel.value==='Other'){spec.classList.remove('hidden');}else{spec.classList.add('hidden');spec.value='';} }
  function toggleProgramDropdown(id){ const radios=document.getElementsByName(`s_${id}_progType`); const dd=document.getElementById(`s_${id}_prog_dropdown`); const spec=document.getElementById(`s_${id}_prog_spec`); let chosen=''; radios.forEach(r=>{if(r.checked)chosen=r.value}); if(chosen==='Special'){dd.classList.remove('hidden');}else{dd.classList.add('hidden');dd.value='';spec.classList.add('hidden');spec.value='';} }
  function toggleOtherProg(id){ const sel=document.getElementById(`s_${id}_prog_dropdown`); const spec=document.getElementById(`s_${id}_prog_spec`); if(sel.value==='Other'){spec.classList.remove('hidden');}else{spec.classList.add('hidden');spec.value='';} }

  addStudent(); // Default first student

  
  
  // ============================================
  // 4. GENERATE FINAL FORM
  // ============================================
  function generateFinal(){
    const final = document.getElementById('finalArea');
    final.innerHTML = '';
    // Reverting title to original state as requested year logic is handled by radio buttons
    final.insertAdjacentHTML('beforeend', `
        <div class="w-full flex items-center justify-between mb-2">
            <h1 class="text-lg font-semibold leading-tight text-left uppercase">
                INFORMATION NEEDED FOR BOOKING APPOINTMENTS<br>AND SENDING REQUESTS
            </h1>
            <img src="One World Logo.jpg" 
                 alt="One World One Centre Logo" 
                 class="w-48 md:w-72 h-auto object-contain">
        </div>
    `);
    
    const scrollWrap = document.createElement('div');
    scrollWrap.className = 'overflow-x-auto';

    const tbl = document.createElement('table');
    tbl.className = 'yellow-table';

    const c = (lbl, val) => `<div class="font-semibold">${lbl}</div><div class="cell-content">${escapeHtml(val)}</div>`;
    
    // ROW 1
    const tr1 = document.createElement('tr');
    tr1.innerHTML = `<td width="15%">${c('DATE', document.getElementById('date').value)}</td><td width="25%">${c('TAKEN BY', document.getElementById('takenBy').value)}</td><td width="25%">${c('CONTACT NAME/SURNAME', document.getElementById('contactName').value)}</td><td width="15%">${c('CONTACT PHONE #', document.getElementById('contactPhone').value)}</td><td width="20%">${c('CONTACT RELATIONSHIP', (document.getElementById('contactRel').value === 'Other' ? document.getElementById('otherRelation').value : document.getElementById('contactRel').value))}</td>`;
    tbl.appendChild(tr1);

    // ROW 2
    const sStat = getRadioValue('studentStatus'); const sStatTxt = sStat==='Other' ? document.getElementById('studentStatusOther').value : sStat;
    const imm = getRadioValue('immDoc'); const immTxt = imm==='Other' ? document.getElementById('immDocOther').value : imm;
    const pAtt = getRadioValue('prevAttend'); const pAttTxt = pAtt==='Yes' ? '☑ Yes' : (pAtt==='No' ? '☑ No' : '');
    const tr2 = document.createElement('tr');
    tr2.innerHTML = `<td>${c("STUDENT'S STATUS", sStatTxt)}</td><td>${c('IMMIGRATION DOCUMENT', immTxt)}</td><td>${c('EXPIRY DATE', document.getElementById('expiry').value)}</td><td>${c('PREVIOUS ATTENDANCE?', pAttTxt)}</td><td>${c('DATE LANDED', document.getElementById('landed').value)}</td>`;
    tbl.appendChild(tr2);

    // ROW 3
    const tr3 = document.createElement('tr');
    tr3.innerHTML = `<td colspan="5" class="no-padding"><table class="nested-table"><tr><td width="25%">${c("FATHER'S SURNAME", document.getElementById('fatherSurname').value)}</td><td width="25%">${c("FATHER'S GIVEN NAME", document.getElementById('fatherGiven').value)}</td><td width="25%">${c("MOTHER'S SURNAME", document.getElementById('motherSurname').value)}</td><td width="25%">${c("MOTHER'S GIVEN NAME", document.getElementById('motherGiven').value)}</td></tr></table></td>`;
    tbl.appendChild(tr3);

    // ROW 4
    const tr4 = document.createElement('tr');
    tr4.innerHTML = `<td colspan="5" class="no-padding"><table class="nested-table"><tr><td width="20%">${c("APARTMENT #", document.getElementById('apt').value)}</td><td width="60%">${c("FAMILY ADDRESS", document.getElementById('address').value)}</td><td width="20%">${c("POSTAL CODE", document.getElementById('postal').value)}</td></tr></table></td>`;
    tbl.appendChild(tr4);

    // ROW 5
    let homeLangs = '';
    const hlSelect = document.getElementById('homeLang');
    if (hlSelect.tomselect) { const val = hlSelect.tomselect.getValue(); homeLangs = Array.isArray(val) ? val.join(', ') : val; } 
    else { homeLangs = Array.from(hlSelect.selectedOptions).map(o=>o.value).join(', '); }
    
    const cath = getRadioValue('catholic'); 
    const relOther = document.getElementById('religionOther').value;
    const cathTxt = `${checkboxMark(cath==='Yes')} Yes  ${checkboxMark(cath==='No')} No` + (relOther ? `<br>Note: ${escapeHtml(relOther)}` : '');  
    const tr5 = document.createElement('tr');
    tr5.innerHTML = `<td colspan="5" class="no-padding"><table class="nested-table"><tr><td width="33%">${c("FAMILY PHONE #", document.getElementById('familyPhone').value)}</td><td width="34%">${c("HOME LANGUAGE", homeLangs)}</td><td width="33%"><div class="font-semibold">CATHOLIC</div><div class="cell-content">${cathTxt}</div></td></tr></table></td>`;
    tbl.appendChild(tr5);

    // --- ROW 6: STUDENTS TABLE ---
    let stRows = '';
    for(let i=1; i<=studentCount; i++){
        const sn = document.getElementById(`s_${i}_surname`)?.value;
        if(!sn && studentCount > 1) continue; 
        
        if(document.getElementById(`s_${i}_surname`)){
            const gn = document.getElementById(`s_${i}_given`).value;
            const dob = document.getElementById(`s_${i}_dob`).value;
            const calcGrade = document.getElementById(`s_${i}_calc_grade`)?.value || ''; // Retrieve calculated grade
            const birth = $(`#s_${i}_birth`).val() || '';
            const gender = getRadioValue(`s_${i}_gender`);
            
            const yearVal = getRadioValue(`s_${i}_year`);
            let year = (yearVal === 'ThisYear') ? '2025-26' : ((yearVal === 'NextYear') ? '2026-27' : '');

            let prog = '';
            const pt = getRadioValue(`s_${i}_progType`);
            if(pt === 'Regular') prog = 'Regular';
            else if(pt === 'Special') {
                const pd = document.getElementById(`s_${i}_prog_dropdown`).value;
                const ps = document.getElementById(`s_${i}_prog_spec`).value;
                prog = `Special - ${pd === 'Other' ? ps : pd}`;
            }

            let grd = document.getElementById(`s_${i}_lastgrade`).value;
            if(grd === 'Other') grd = document.getElementById(`s_${i}_lastgrade_spec`).value;

            stRows += `<tr class="student-row">
                <td class="cell-content">${escapeHtml(sn)}</td>
                <td class="cell-content">${escapeHtml(gn)}</td>
                <td class="text-center cell-content">${escapeHtml(gender)}</td>
                <td class="text-center cell-content">${escapeHtml(dob)}</td>
                <td class="text-center font-bold" style="background-color:#fcf89f;">${escapeHtml(calcGrade)}</td>
                <td class="cell-content">${escapeHtml(birth)}</td>
                <td class="text-center">${escapeHtml(grd)}</td>
                <td class="text-center">${year}</td>
                <td class="text-center cell-content">${escapeHtml(prog)}</td>
            </tr>`;
        }
    }

    const tr6 = document.createElement('tr');
    tr6.innerHTML = `<td colspan="5" class="no-padding">
        <table class="nested-table">
            <tr style="background-color:#fcf89f; border-bottom: 1px solid #000000; font-size: 8pt;">
                <th width="17%">STUDENT'S SURNAME</th>
                <th width="17%">STUDENT'S GIVEN NAME</th>
                <th width="6%">GENDER</th>
                <th width="11%">DOB: YYYY/MM/DD</th>
                <th width="10%">GRADE PLACEMENT</th>
                <th width="12%">BIRTH COUNTRY</th>
                <th width="8%">LAST GRADE</th>
                <th width="8%">SCHOOL YEAR</th>
                <th width="11%">PROGRAM</th>
            </tr>
            ${stRows}
        </table>
    </td>`;
    tbl.appendChild(tr6);

    // --- ROW 7: LIMITED PROFILE ---
    const lim = getRadioValue('limitedProfile');
    const limDet = document.getElementById('limitedProfileDetails').value;
    const tr7 = document.createElement('tr');
    let limContent = `<div class="font-semibold">POTENTIAL LIMITED FORMAL SCHOOLING PROFILE</div>`;
    limContent += `<div>${checkboxMark(lim==='Yes')} Yes  ${checkboxMark(lim==='No')} No</div>`;
    if (lim === 'Yes') {
        limContent += `<div style="font-size:10px; margin-top: 5px; color:#555;">If YES, describe for each student...</div>`;
        limContent += `<div class="cell-content" style="padding: 5px 20px; white-space: pre-wrap;">${escapeHtml(limDet)}</div>`;
    }
    tr7.innerHTML = `<td colspan="5">${limContent}</td>`;
    tbl.appendChild(tr7);

    // --- ROW 8: NOTES ---
    const notes = document.getElementById('notes').value;
    const tr8 = document.createElement('tr');
    tr8.innerHTML = `<td colspan="5"><div class="font-semibold">NOTES</div><div class="cell-content" style="padding: 5px 20px; white-space: pre-wrap;">${escapeHtml(notes)}</div></td>`;
    tbl.appendChild(tr8);

    scrollWrap.appendChild(tbl);
    final.appendChild(scrollWrap);
    
    document.getElementById('wizardRoot').classList.add('hidden');
    document.getElementById('finalWrap').classList.remove('hidden');
    window.scrollTo({top:0, behavior:'smooth'});
  }

  // ============================================
  // 5. INITIALIZATION
  // ============================================
  
  // Page 1 Select2
  $(document).ready(function() {
    $('#contactRel').select2({ dropdownParent: $(document.body), dropdownPosition: 'below', width: '100%' });
  });

  // Home Language TomSelect
  const languages = [
    "English", "Tigrinya", "Amharic", "Arabic", "French", "Spanish", "Somali", "Swahili", "Hindi",
    "Mandarin Chinese", "Cantonese", "Portuguese", "Tagalog", "Italian", "German", "Russian",
    "Punjabi", "Urdu", "Bengali", "Korean", "Japanese", "Vietnamese", "Cree", "Ojibwe", "Inuktitut",
    "Persian (Farsi)", "Kurdish", "Pashto", "Ukrainian", "Polish", "Turkish", "Greek", "Tamil",
    "Malayalam", "Telugu", "Gujarati", "Thai", "Indonesian", "Malay", "Burmese", "Sinhalese",
    "Nepali", "Dari", "Hebrew", "Armenian", "Albanian", "Serbian", "Croatian", "Bosnian",
    "Bulgarian", "Romanian", "Dutch", "Swedish", "Finnish", "Norwegian", "Danish", "Czech",
    "Slovak", "Hungarian", "Latvian", "Lithuanian", "Estonian", "Haitian Creole", "Afrikaans",
    "Zulu", "Xhosa", "Shona", "Twi", "Ewe", "Yoruba", "Igbo", "Hausa", "Oromo", "Tigré", "Nuer",
    "Dinka", "Acholi", "Somali Bantu", "Khmer", "Lao", "Mongolian", "Kazakh", "Uzbek", "Tajik",
    "Azerbaijani", "Georgian", "Macedonian", "Cebuano (Bisaya)", "Catalan", "Basque", "Galician",
    "Samoan", "Tongan", "Fijian", "Fula", "Maori", "Luganda", "Bantu", "Bilen", "Kinyarwanda",
    "Kinyabwishya", "Kinyamulenge", "Kikongo ya leta", "Lingala", "Mano", "Kpelle", "Kikuyu",
    "Kamba", "Other"
  ];
  
  document.addEventListener('DOMContentLoaded', () => {
    const select = document.getElementById('homeLang');
    languages.forEach(lang => { const opt = document.createElement('option'); opt.value = lang; opt.textContent = lang; select.appendChild(opt); });
    new TomSelect(select, { placeholder: "Select or type language(s)", maxOptions: 500, create: true, plugins: ['remove_button'] });
  });

  // Buttons Logic & PDF
  function downloadPDF(orientation) {
      const final = document.getElementById('finalArea');
      final.classList.add('pdf-scale');
      document.getElementById('orientationSelector').classList.add('hidden');
      
      const opt = { 
          margin: 0.2, 
          filename: `intake-form-${orientation}.pdf`, 
          image: { type: 'jpeg', quality: 0.98 }, 
          html2canvas: { scale: 2, useCORS: true }, 
          jsPDF: { unit: 'in', format: 'a4', orientation: orientation } 
      };
      
      html2pdf().set(opt).from(final).save().then(() => { final.classList.remove('pdf-scale'); });
  }

  document.getElementById('editBtn').onclick = () => {
    document.getElementById('wizardRoot').classList.remove('hidden');
    document.getElementById('finalWrap').classList.add('hidden');
    document.getElementById('orientationSelector').classList.add('hidden');
    window.scrollTo({top:0,behavior:'smooth'});
  }

  document.getElementById('pdfBtn').onclick = (event) => {
      event.stopPropagation();
      document.getElementById('orientationSelector').classList.toggle('hidden');
  }

  document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('downloadPortraitBtn').onclick = () => downloadPDF('portrait');
      document.getElementById('downloadLandscapeBtn').onclick = () => downloadPDF('landscape');
  });

  document.addEventListener('click', function(event) {
      const selector = document.getElementById('orientationSelector');
      const pdfBtn = document.getElementById('pdfBtn');
      if (!selector.classList.contains('hidden') && event.target !== selector && !selector.contains(event.target) && event.target !== pdfBtn) {
          selector.classList.add('hidden');
      }
  });

  document.getElementById('newFormBtn').onclick = () => { if(!confirm("Start new form? Data will be lost.")) return; location.reload(); };


  // ============================================
  // 6. KEYBOARD NAVIGATION
  // ============================================
  document.addEventListener('DOMContentLoaded', () => {
    function getFocusableElements(container) {
        if (!container) return [];
        const selector = 'input:not([type="hidden"]):not([disabled]), select:not([disabled]), textarea:not([disabled]), button:not([disabled]), a[href]';
        let elements = Array.from(container.querySelectorAll(selector));
        const select2Triggers = Array.from(container.querySelectorAll('.select2-selection'));
        const tomSelectInputs = Array.from(container.querySelectorAll('.ts-control input'));
        const allCandidates = [...elements, ...select2Triggers, ...tomSelectInputs];

        return allCandidates.filter(el => {
            if (el.closest('.nav-buttons')) return false;
            if (el.offsetParent === null) return false;
            if (el.tagName === 'SELECT' && (el.classList.contains('select2-hidden-accessible') || el.style.display === 'none')) return false;
            if (el.closest('.hidden')) return false;
            return true;
        }).sort((a, b) => {
            return (a.compareDocumentPosition(b) & Node.DOCUMENT_POSITION_FOLLOWING) ? -1 : 1;
        });
    }

    document.addEventListener('keydown', function(event) {
        const currentStep = document.querySelector('.page:not(.hidden)');
        if (!currentStep) return;

        const activeEl = document.activeElement;
        const key = event.key;
        const isShift = event.shiftKey;

        // Shift+Arrow = Page Nav
        if (isShift && (key === 'ArrowLeft' || key === 'ArrowRight')) {
            event.preventDefault();
            const currentStepNum = parseInt(currentStep.dataset.step, 10);
            let nextStepNum = key === 'ArrowRight' ? currentStepNum + 1 : currentStepNum - 1;
            if (typeof goTo === 'function' && nextStepNum >= 1 && nextStepNum <= 6) {
                goTo(nextStepNum);
                setTimeout(() => {
                    const newPage = document.querySelector(`.page[data-step="${nextStepNum}"]`);
                    const focusables = getFocusableElements(newPage);
                    if (focusables[0]) focusables[0].focus();
                }, 50);
            }
            return;
        }

        // Arrow Keys = Field Nav
        if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(key)) {
            const isSelect2Open = document.querySelector('.select2-container--open');
            const tsWrapper = activeEl.closest('.ts-wrapper');
            const isTomSelectOpen = tsWrapper && tsWrapper.classList.contains('input-active') && activeEl.closest('.ts-control');
            if (isSelect2Open || isTomSelectOpen) return; 

            const isTextLike = activeEl.tagName === 'INPUT' && ['text', 'password', 'email', 'tel', 'number', 'search', 'url'].includes(activeEl.type);
            const isTextArea = activeEl.tagName === 'TEXTAREA';
            
            if (isTextLike || isTextArea) {
                 try {
                    if (key === 'ArrowLeft' && activeEl.selectionStart > 0) return;
                    if (key === 'ArrowRight' && activeEl.selectionStart < activeEl.value.length) return;
                } catch (e) {}
            }
            if (activeEl.tagName === 'INPUT' && activeEl.type === 'date') {
                 if (key === 'ArrowLeft' || key === 'ArrowRight') return; 
            }

            event.preventDefault(); 
            const focusables = getFocusableElements(currentStep);
            if (focusables.length === 0) return;

            const idx = focusables.indexOf(activeEl);
            let nextIdx = idx;

            if (key === 'ArrowRight' || key === 'ArrowDown') {
                nextIdx = (idx + 1) % focusables.length;
            } else {
                nextIdx = (idx - 1 + focusables.length) % focusables.length;
            }

            if (focusables[nextIdx]) focusables[nextIdx].focus();
        }

        // Enter Key
        if (key === 'Enter') {
            if (activeEl.tagName === "SELECT") return; 
            if (activeEl.tagName === 'TEXTAREA') return; 

            event.preventDefault(); 

            if (activeEl.type === 'radio') {
                if (activeEl.checked && activeEl.wasChecked) {
                    activeEl.checked = false;
                    activeEl.wasChecked = false;
                    if (activeEl.value === "Other") {
                        const target = activeEl.getAttribute("onchange")?.match(/'(.*?)'/)?.[1];
                        if (target) {
                            const input = document.getElementById(target);
                            input.classList.add("hidden");
                            input.value = "";
                        }
                    }
                    // Crucial: Re-run updateGrade if unchecking a year radio
                    if (activeEl.name.endsWith('_year')) {
                         const studentId = activeEl.name.split('_')[1];
                         updateGrade(studentId);
                    }
                    return;
                }
                document.querySelectorAll(`input[name="${activeEl.name}"]`).forEach(r => (r.wasChecked = false));
                activeEl.wasChecked = true;
                activeEl.checked = true;
                activeEl.dispatchEvent(new Event('change', { bubbles: true }));
                return;
            }

            if (activeEl.classList.contains('select2-selection')) { $(activeEl).trigger('click'); return; }
            if (activeEl.closest('.ts-control')) { activeEl.click(); return; }
            if (activeEl.tagName === 'BUTTON') { activeEl.click(); }
        }

        // Spacebar Shortcut for Generate
        if (key === ' ' && currentStep.dataset.step === '6') {
            const isTextType = activeEl.tagName === 'INPUT' && activeEl.type !== 'radio' && activeEl.type !== 'checkbox';
            if (isTextType || activeEl.tagName === 'TEXTAREA') { return; }
            const generateBtn = document.querySelector('.page[data-step="6"] button:last-child');
            if (generateBtn && generateBtn.textContent.includes('Generate Yellow Form')) {
                event.preventDefault();
                generateBtn.click();
            }
        }
    });
});
</script>

</body>
</html>
