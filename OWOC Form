<!doctype html>
<html lang="en"> 
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>One World One Centre Student Intake Form</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

  <link href="https://cdn.jsdelivr.net/npm/tom-select/dist/css/tom-select.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/tom-select/dist/js/tom-select.complete.min.js"></script>

  <style>
    /* GLOBAL BOX SIZING FIX (Prevents overflow) */
    *, *::before, *::after { box-sizing: border-box; }

    /* BASIC LAYOUT */
    body { margin: 0; border: 3px solid #C7631C; min-height: 100vh; background-color: white; }
    .wizard { background-color: white; border-radius: 0.5rem; padding: 2rem; margin: 2rem auto; max-width: 1100px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    .page { position: relative; min-height: 70vh; background-color: white; padding: 1.5rem; border-radius: 0.5rem; display: flex; flex-direction: column; justify-content: space-between; }
    .nav-buttons { display: flex; justify-content: space-between; margin-top: auto; padding-top: 1rem; }
    
    /* INPUT STYLES */
    select { transform-origin: top center !important; }
    .disabled-input { background:#f3f4f6; color:#6b7280; pointer-events: none; }
    
    /* =========================================
       STRICT YELLOW TABLE STYLING
       ========================================= */
    
    /* 1. The Outer Table */
    table.yellow-table {
        width: 100%;
        border-collapse: collapse; 
        border: 2px solid black; 
        font-size: 0.8rem;
        table-layout: fixed; /* CRITICAL for overflow prevention */
    }

    /* 2. Standard Cells */
    table.yellow-table td, 
    table.yellow-table th { 
        border: 1px solid black; 
        padding: 4px 6px; 
        vertical-align: top;
        word-wrap: break-word;
        overflow-wrap: anywhere; 
    }

    /* 3. Nested Tables */
    table.nested-table {
        width: 100%;
        border-collapse: collapse;
        margin: -1px; 
        width: calc(100% + 2px);
        table-layout: fixed;
    }

    /* Default nested cells: no top/bottom border to fit snug */
    table.nested-table td {
        border: 1px solid black !important;
        border-top: none !important;
        border-bottom: none !important;
    }
    
    /* 4. STUDENT ROW SPECIFIC FIXES (The separator lines) */
    /* We Override the 'no bottom border' rule for student rows */
    tr.student-row td {
        border-bottom: 1px solid black !important; 
    }
    /* Optional: Remove border from the very last student to match parent bottom */
    tr.student-row:last-child td {
        border-bottom: none !important;
    }

    /* Remove side borders for nested tables */
    table.nested-table td:first-child { border-left: none !important; }
    table.nested-table td:last-child { border-right: none !important; }

    /* Helper for container cells */
    td.no-padding { padding: 0 !important; height: 100%; }

    /* Text Formatting */
    .font-semibold { font-weight: 700; margin-bottom: 2px; font-size: 0.75rem; text-transform: uppercase; }
    
    /* Content Wrapper to catch overflow */
    .cell-content { 
        width: 100%; 
        min-height: 18px; 
        word-break: break-word; 
        overflow-wrap: anywhere;
    }

    /* PDF Print Specifics */
    #finalArea.pdf-scale { width: 100%; font-size: 10px !important; }
    
    /* Library Tweaks */
    .select2-container .select2-selection--single { height: 42px; border: 1px solid #d1d5db; padding: 6px; }
    .select2-container--default .select2-selection--single .select2-selection__arrow { height: 42px; top: 0; }
  </style>
</head>

<body class="bg-gray-100 text-gray-800">
  <div class="max-w-5xl mx-auto p-6">
    <div id="wizardRoot" class="wizard bg-white rounded-lg shadow p-6">
       <h1 class="text-xl font-semibold mb-6 ml-6">INFORMATION NEEDED FOR BOOKING APPOINTMENTS AND SENDING REQUESTS</h1>

      <section class="page" data-step="1">
        <h2 class="font-medium mb-3">Page 1</h2>
        <div class="grid grid-cols-12 gap-3">
          <div class="col-span-2">
            <label class="block text-sm">DATE</label>
            <input id="date" type="date" class="w-full border rounded p-2 mt-1" />
          </div>
          <div class="col-span-3">
            <label class="block text-sm">TAKEN BY</label>
            <input id="takenBy" type="text" class="w-full border rounded p-2 mt-1" />
          </div>
          <div class="col-span-4">
            <label class="block text-sm">CONTACT NAME / SURNAME</label>
            <input id="contactName" type="text" class="w-full border rounded p-2 mt-1" />
          </div>
          <div class="col-span-2">
            <label class="block text-sm">CONTACT PHONE #</label>
            <input id="contactPhone" type="text" maxlength="14" class="w-full border rounded p-2 mt-1" oninput="formatPhone(this)" />
          </div>
          <div class="col-span-4">
            <label class="block text-sm mt-6">CONTACT RELATIONSHIP</label>
            <select id="contactRel" class="border rounded p-3 w-72" onchange="toggleOtherRelation(this)">
              <option value="" disabled selected hidden>-- Select --</option>
              <option value="Mother">Mother</option>
              <option value="Father">Father</option>
              <option value="Guardian">Guardian</option>
              <option value="Other">Other</option>
            </select>
            <input type="text" id="otherRelation" class="border rounded p-2 w-72 mt-2 hidden" placeholder="Specify" />
          </div>
        </div>
        <div class="nav-buttons justify-end">
          <button type="button" class="px-4 py-2 bg-green-700 text-white rounded" onclick="goTo(2)">Next</button>
        </div>
      </section>








      <section class="page hidden" data-step="2">
        <h2 class="font-medium mb-3">Page 2</h2>
        <div class="grid grid-cols-12 gap-3 mb-3">
          <div class="col-span-6">
            <label class="block text-sm">STUDENT'S STATUS</label>
            <div class="mt-1 flex flex-wrap gap-3">
              <label><input type="radio" name="studentStatus" value="PR" onchange="toggleOtherField('studentStatusOther', this)"> PR</label>
              <label><input type="radio" name="studentStatus" value="RC" onchange="toggleOtherField('studentStatusOther', this)"> RC</label>
              <label><input type="radio" name="studentStatus" value="WP" onchange="toggleOtherField('studentStatusOther', this)"> WP</label>
              <label><input type="radio" name="studentStatus" value="Other" onchange="toggleOtherField('studentStatusOther', this)"> Other</label>
              <input id="studentStatusOther" type="text" class="hidden border rounded p-1 ml-2" placeholder="Specify" />
            </div>
          </div>
          <div class="col-span-6">
            <label class="block text-sm">IMMIGRATION DOC (PARENT)</label>
            <div class="mt-1 flex flex-wrap gap-3">
              <label><input type="radio" name="immDoc" value="PR" onchange="toggleOtherField('immDocOther', this)"> PR</label>
              <label><input type="radio" name="immDoc" value="RC" onchange="toggleOtherField('immDocOther', this)"> RC</label>
              <label><input type="radio" name="immDoc" value="WP" onchange="toggleOtherField('immDocOther', this)"> WP</label>
              <label><input type="radio" name="immDoc" value="Other" onchange="toggleOtherField('immDocOther', this)"> Other</label>
              <input id="immDocOther" type="text" class="hidden border rounded p-1 ml-2" placeholder="Specify" />
            </div>
          </div>
          <div class="col-span-4 mt-2">
            <label class="block text-sm">EXPIRY DATE</label>
            <input id="expiry" type="date" class="w-full border rounded p-2 mt-1" />
          </div>
          <div class="col-span-12 mt-2">
            <label class="block text-sm">PREVIOUS ATTENDANCE IN CANADIAN SCHOOLS?</label>
            <div class="mt-1 flex gap-4">
              <label><input type="radio" name="prevAttend" value="No" onchange="toggleAttendance(false)"> No</label>
              <label><input type="radio" name="prevAttend" value="Yes" onchange="toggleAttendance(true)"> Yes</label>
            </div>
            <input id="prevDetails" type="text" class="mt-2 w-full border rounded p-2 disabled-input" placeholder="Details..." disabled />
          </div>
          <div class="col-span-4 mt-2">
            <label class="block text-sm">DATE LANDED</label>
            <input id="landed" type="date" class="w-full border rounded p-2 mt-1" />
          </div>
        </div>
        <div class="nav-buttons">
          <button type="button" class="px-4 py-2 bg-gray-500 text-white rounded" onclick="goTo(1)">Back</button>
          <button type="button" class="px-4 py-2 bg-green-700 text-white rounded" onclick="goTo(3)">Next</button>
        </div>
      </section>

      <section class="page hidden" data-step="3">
        <h2 class="font-medium mb-3">Page 3</h2>
        <div class="grid grid-cols-12 gap-3">
          <div class="col-span-3"><label class="block text-sm">FATHER'S SURNAME</label><input id="fatherSurname" type="text" class="w-full border rounded p-2 mt-1" /></div>
          <div class="col-span-3"><label class="block text-sm">FATHER'S GIVEN NAME</label><input id="fatherGiven" type="text" class="w-full border rounded p-2 mt-1" /></div>
          <div class="col-span-3"><label class="block text-sm">MOTHER'S SURNAME</label><input id="motherSurname" type="text" class="w-full border rounded p-2 mt-1" /></div>
          <div class="col-span-3"><label class="block text-sm">MOTHER'S GIVEN NAME</label><input id="motherGiven" type="text" class="w-full border rounded p-2 mt-1" /></div>
        </div>
        <div class="nav-buttons">
          <button type="button" class="px-4 py-2 bg-gray-500 text-white rounded" onclick="goTo(2)">Back</button>
          <button type="button" class="px-4 py-2 bg-green-700 text-white rounded" onclick="goTo(4)">Next</button>
        </div>
      </section>

      <section class="page hidden" data-step="4">
        <h2 class="font-medium mb-3">Page 4</h2>
        <div class="grid grid-cols-12 gap-3">
          <div class="col-span-2"><label class="block text-sm">APARTMENT #</label><input id="apt" type="text" class="w-full border rounded p-2 mt-1" /></div>
          <div class="col-span-8"><label class="block text-sm">FAMILY ADDRESS</label><input id="address" type="text" class="w-full border rounded p-2 mt-1" /></div>
          <div class="col-span-2"><label class="block text-sm">POSTAL CODE</label><input id="postal" type="text" class="w-full border rounded p-2 mt-1" oninput="enforcePostalFormat(this)" /></div>
          <div class="col-span-2 mt-2"><label class="block text-sm">FAMILY PHONE #</label><input id="familyPhone" type="text" class="w-full border rounded p-2 mt-1" oninput="formatPhone(this)" /></div>
          <div class="col-span-6 mt-2 ml-4"><label class="block text-sm">HOME LANGUAGE(S)</label><select id="homeLang" multiple class="w-full border rounded p-2 mt-1"></select></div>
          <div class="col-span-12 mt-2">
            <label class="block text-sm">CATHOLIC</label>
            <div class="flex gap-4"><label><input type="radio" name="catholic" value="No"> No</label><label><input type="radio" name="catholic" value="Yes"> Yes</label></div>
            <input id="religionOther" type="text" class="mt-2 w-full border rounded p-2" placeholder="If not Catholic..." />
          </div>
        </div>
        <div class="nav-buttons mt-4">
          <button type="button" class="px-4 py-2 bg-gray-500 text-white rounded" onclick="goTo(3)">Back</button>
          <button type="button" class="px-4 py-2 bg-green-700 text-white rounded" onclick="goTo(5)">Next</button>
        </div>
      </section>

      <section class="page hidden" data-step="5">
        <h2 class="font-medium mb-3">Page 5 — Student Details</h2>
        <div id="studentsContainer" class="space-y-4"></div>
        <div class="flex items-center gap-3 mt-3">
          <button class="px-3 py-2 bg-blue-600 text-white rounded" onclick="addStudent()" type="button">Add Student</button>
          <button class="px-3 py-2 bg-red-500 text-white rounded" onclick="removeStudent()" type="button">Remove Last</button>
        </div>
        <div class="nav-buttons">
          <button type="button" class="px-4 py-2 bg-gray-500 text-white rounded" onclick="goTo(4)">Back</button>
          <button type="button" class="px-4 py-2 bg-green-700 text-white rounded" onclick="goTo(6)">Next</button>
        </div>
      </section>

      <section class="page hidden" data-step="6">
        <h2 class="font-medium mb-3">Page 6</h2>
        <div class="grid grid-cols-12 gap-3">
            <div class="col-span-6"><label class="block text-sm">LIMITED FORMAL SCHOOLING?</label><div class="flex gap-4"><label><input type="radio" name="limitedProfile" value="No" onchange="toggleLimitedProfile(false)"> No</label><label><input type="radio" name="limitedProfile" value="Yes" onchange="toggleLimitedProfile(true)"> Yes</label></div></div>
        </div>
        <div id="limitedProfileBox" class="col-span-12 mt-4 hidden">
            <label class="block text-sm">Details:</label>
            <textarea id="limitedProfileDetails" class="w-full border rounded p-2 mt-2"></textarea>
        </div>
        <div class="col-span-12 mt-4"><label class="block text-sm">NOTE:</label><textarea id="notes" class="w-full border rounded p-2 mt-1"></textarea></div>
        <div class="nav-buttons">
          <button class="px-4 py-2 bg-gray-500 text-white rounded" onclick="goTo(5)">Back</button>
          <button class="px-4 py-2 bg-green-700 text-white rounded" onclick="generateFinal()">Generate Yellow Form</button>
        </div>
      </section>
    </div>

    <div id="finalWrap" class="final-wrap hidden mt-6">
      <div id="finalArea" class="p-6 rounded shadow border" style="background-color: #fff989;"></div>
      <div class="mt-4 flex justify-center gap-3">
        <button id="editBtn" class="px-4 py-2 bg-green-700 text-white rounded">Back to Edit</button>
        <button id="printBtn" class="px-4 py-2 bg-blue-600 text-white rounded" onclick="window.print()">Print</button>
        <button id="pdfBtn" class="px-4 py-2 text-white rounded" style="background-color: #C7631C;">Download PDF</button>
        <button id="newFormBtn" class="px-4 py-2 bg-red-700 text-white rounded">New Form</button>
      </div>
    </div>
  </div>





  <script>
  // ============================================
  // 1. GLOBAL VARIABLES & UTILS
  // ============================================
  let currentStep = 1;
  let studentCount = 0;
  let countries = [];
  let countriesLoaded = false;
  const loadCountriesPromise = loadCountries(); 

  // --- HTML ESCAPE HELPER ---
  function escapeHtml(str) { 
    if (!str) return ''; 
    return String(str)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#039;');
  }

  // --- CHECKBOX/RADIO HELPERS ---
  function checkboxMark(cond){ return cond ? '☑' : '☐' }
  
  function getRadioValue(name){ 
    const r = document.querySelector(`input[name='${name}']:checked`); 
    return r ? r.value : ''; 
  }

  // --- NAVIGATION ---
  function goTo(step){
    if (step < 1 || step > 6) return;
    document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
    const target = document.querySelector(`.page[data-step='${step}']`);
    if(target) {
        target.classList.remove('hidden');
        currentStep = step;
        window.scrollTo({top:0, behavior:'smooth'});
    }
  }

  // --- VISIBILITY TOGGLES ---
  function toggleOtherField(id, el){ 
    const inp = document.getElementById(id); 
    if(el.value === 'Other' && el.checked){ 
        inp.classList.remove('hidden'); 
        inp.focus(); 
    } else { 
        inp.classList.add('hidden'); 
        inp.value = ''; 
    }
  }

  function toggleOtherRelation(select){
    const otherBox = document.getElementById('otherRelation');
    if(select.value === 'Other'){ 
        otherBox.classList.remove('hidden'); 
        otherBox.focus(); 
    } else { 
        otherBox.classList.add('hidden'); 
        otherBox.value = ''; 
    }
  }

  function toggleAttendance(isYes){
    const d = document.getElementById('prevDetails');
    if(isYes){ 
        d.disabled = false; 
        d.classList.remove('disabled-input'); 
        d.focus(); 
    } else { 
        d.disabled = true; 
        d.classList.add('disabled-input'); 
        d.value = ''; 
    }
  }

  function toggleLimitedProfile(isYes) {
    const box = document.getElementById('limitedProfileBox');
    if (isYes) { 
        box.classList.remove('hidden'); 
    } else { 
        box.classList.add('hidden'); 
        document.getElementById('limitedProfileDetails').value = ''; 
    }
  }

  // --- FORMATTING HELPERS ---
  function formatPhone(input) {
    let value = input.value.replace(/\D/g, '');
    if (value.length > 3 && value.length <= 6) {
      input.value = '(' + value.slice(0,3) + ') ' + value.slice(3);
    } else if (value.length > 6) {
      input.value = '(' + value.slice(0,3) + ') ' + value.slice(3,6) + '-' + value.slice(6,10);
    } else {
      input.value = value;
    }
  }

  function enforcePostalFormat(input) {
    let value = input.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
    let formatted = '';
    if (value.length > 0) formatted += value[0].replace(/[^A-Z]/g, '');
    if (value.length > 1) formatted += value[1].replace(/[^0-9]/g, '');
    if (value.length > 2) formatted += value[2].replace(/[^A-Z]/g, '');
    if (value.length > 3) formatted += ' ' + value[3].replace(/[^0-9]/g, '');
    if (value.length > 4) formatted += value[4].replace(/[^A-Z]/g, '');
    if (value.length > 5) formatted += value[5].replace(/[^0-9]/g, '');
    input.value = formatted;
  }

  // Force Date Year Limit
  document.addEventListener("input", function (e) {
    if (e.target.type === "date") {
      let v = e.target.value;
      if (v.length >= 5 && v[4] !== "-") {
        let parts = v.split("-");
        if (parts[0].length > 4) { parts[0] = parts[0].substring(0, 4); }
        e.target.value = parts.join("-");
      }
    }
  });

  // ============================================
  // 2. DATA LOADING (COUNTRIES & LANGUAGES)
  // ============================================
  async function loadCountries(){
    try {
      const res = await fetch("https://restcountries.com/v3.1/all?fields=name");
      const data = await res.json();
      countries = data.map(c => c.name?.common).filter(Boolean).sort((a, b) => a.localeCompare(b));
    } catch(err){
      console.error("API Error, using fallback", err);
      countries = ["Afghanistan","Canada","China","Eritrea","Ethiopia","India","Mexico","Philippines","Syria","Ukraine","United States","Vietnam","Other"];
    } finally {
      countriesLoaded = true;
    }
  }

  function populateCountrySelectById(selectEl, selectedValue){
    const $s = $(selectEl);
    $s.empty();
    $s.append($('<option disabled>').text('Select country').prop('selected', !selectedValue).prop('hidden', true));
    
    countries.forEach(c => {
      $s.append($('<option>').val(c).text(c));
    });

    if($s.data('select2')) { $s.select2('destroy'); }
    
    $s.select2({
      width: '100%',
      placeholder: "Search for a country",
      dropdownParent: $(document.body)
    });

    if(selectedValue) { $s.val(selectedValue).trigger('change'); }
  }

  // ============================================
  // 3. DYNAMIC STUDENT ROWS
  // ============================================
  function addStudent(prefill){
    studentCount++;
    const id = studentCount;
    const container = document.getElementById('studentsContainer');
    const wrap = document.createElement('div');
    wrap.className = 'p-4 border rounded bg-gray-50 mb-4';
    wrap.id = `student-${id}`;

    wrap.innerHTML = `
      <div class="grid grid-cols-12 gap-4">
        <div class="col-span-3">
            <label class="text-xs font-bold text-gray-700">STUDENT'S SURNAME</label>
            <input type="text" id="s_${id}_surname" class="w-full border rounded p-2 mt-1" value="${prefill?.surname||''}" />
        </div>
        <div class="col-span-3">
            <label class="text-xs font-bold text-gray-700">STUDENT'S GIVEN NAME</label>
            <input type="text" id="s_${id}_given" class="w-full border rounded p-2 mt-1" value="${prefill?.given||''}" />
        </div>
        <div class="col-span-3">
            <label class="text-xs font-bold text-gray-700">DOB</label>
            <input type="date" id="s_${id}_dob" class="w-full border rounded p-2 mt-1" value="${prefill?.dob||''}" />
        </div>
        <div class="col-span-3">
            <label class="text-xs font-bold text-gray-700">BIRTH COUNTRY</label>
            <select id="s_${id}_birth" class="country-select w-full border rounded p-2 mt-1">
                <option disabled selected>Loading...</option>
            </select>
        </div>
      </div>

      <div class="grid grid-cols-12 gap-4 mt-3">
        <div class="col-span-4 overflow-visible">
            <label class="text-xs font-bold text-gray-700">LAST GRADE COMPLETED</label>
            <select id="s_${id}_lastgrade" class="w-full border rounded p-2 mt-1" onchange="toggleOtherGrade(${id})">
                <option value="" disabled selected hidden>Select grade</option>
                <option value="Pre KG">Pre KG</option>
                <option value="KG">KG</option>
                ${Array.from({length:12},(_,i)=>`<option value="Grade ${i+1}">Grade ${i+1}</option>`).join('')}
                <option value="Other">Other</option>
            </select>
            <input type="text" id="s_${id}_lastgrade_spec" class="w-full border rounded p-2 mt-1 hidden" placeholder="Specify grade" />
        </div>

        <div class="col-span-8">
            <label class="text-xs font-bold text-gray-700">PROGRAM</label>
            <div class="mt-1 p-2 border rounded bg-white">
                <div class="flex items-center gap-4">
                    <label class="inline-flex items-center"><input type="radio" name="s_${id}_progType" value="Regular" class="mr-2" onchange="toggleProgramDropdown(${id})">Regular</label>
                    <label class="inline-flex items-center"><input type="radio" name="s_${id}_progType" value="Special" class="mr-2" onchange="toggleProgramDropdown(${id})">Special</label>
                </div>
                <select id="s_${id}_prog_dropdown" class="w-full border rounded p-2 mt-2 hidden" onchange="toggleOtherProg(${id})">
                    <option value="" disabled selected hidden>Select program</option>
                    <option value="French Immersion">French Immersion</option>
                    <option value="Spanish Bilingual">Spanish Bilingual</option>
                    <option value="Ukrainian Bilingual">Ukrainian Bilingual</option>
                    <option value="Other">Other</option>
                </select>
                <input type="text" id="s_${id}_prog_spec" class="w-full border rounded p-2 mt-2 hidden" placeholder="Specify program" />
            </div>
        </div>
      </div>

      <div class="grid grid-cols-12 gap-4 mt-3">
        <div class="col-span-6">
            <label class="text-xs font-bold text-gray-700">GENDER</label>
            <div class="mt-1 flex items-center gap-6 p-2 border rounded bg-white">
                <label class="inline-flex items-center"><input type="radio" name="s_${id}_gender" value="F" class="mr-2">F</label>
                <label class="inline-flex items-center"><input type="radio" name="s_${id}_gender" value="M" class="mr-2">M</label>
            </div>
        </div>
        <div class="col-span-6">
            <label class="text-xs font-bold text-gray-700">SCHOOL YEAR</label>
            <div class="mt-1 flex items-center gap-6 p-2 border rounded bg-white">
                <label class="inline-flex items-center"><input type="radio" name="s_${id}_year" value="ThisYear" class="mr-2">This year</label>
                <label class="inline-flex items-center"><input type="radio" name="s_${id}_year" value="NextYear" class="mr-2">Next year</label>
            </div>
        </div>
      </div>
    `;

    container.appendChild(wrap);

    const selectEl = wrap.querySelector(`#s_${id}_birth`);
    if (countriesLoaded) {
      populateCountrySelectById(selectEl, prefill?.birth || '');
    } else {
      loadCountriesPromise.then(()=> populateCountrySelectById(selectEl, prefill?.birth || ''));
    }

    if(studentCount > 1) window.scrollTo({top:wrap.offsetTop-60, behavior:'smooth'});
  }

  function removeStudent(){ 
    if(studentCount===0) return; 
    const el=document.getElementById(`student-${studentCount}`); 
    if(el) el.remove(); 
    studentCount--; 
  }

  // Toggles inside student cards
  function toggleOtherGrade(id){
    const sel = document.getElementById(`s_${id}_lastgrade`);
    const spec = document.getElementById(`s_${id}_lastgrade_spec`);
    if(sel.value === 'Other'){ spec.classList.remove('hidden'); } 
    else { spec.classList.add('hidden'); spec.value = ''; }
  }

  function toggleProgramDropdown(id){
    const radios = document.getElementsByName(`s_${id}_progType`);
    const dropdown = document.getElementById(`s_${id}_prog_dropdown`);
    const spec = document.getElementById(`s_${id}_prog_spec`);
    let chosen = '';
    radios.forEach(r => { if(r.checked) chosen = r.value });

    if(chosen === 'Special'){
      dropdown.classList.remove('hidden');
    } else {
      dropdown.classList.add('hidden'); dropdown.value = '';
      spec.classList.add('hidden'); spec.value = '';
    }
  }

  function toggleOtherProg(id){
    const sel = document.getElementById(`s_${id}_prog_dropdown`);
    const spec = document.getElementById(`s_${id}_prog_spec`);
    if(sel.value === 'Other'){ spec.classList.remove('hidden'); } 
    else { spec.classList.add('hidden'); spec.value = ''; }
  }

  // Add the first student by default
  addStudent();

  // ============================================
  // 4. GENERATE FINAL FORM (COMPLETE)
  // ============================================
  function generateFinal(){
    const final = document.getElementById('finalArea');
    final.innerHTML = '';
    
    final.insertAdjacentHTML('beforeend', '<h1 class="text-xl font-semibold mb-6 ml-0 pl-0.5">INFORMATION NEEDED FOR BOOKING APPOINTMENTS AND SENDING REQUESTS</h1>');

    const tbl = document.createElement('table');
    tbl.className = 'yellow-table';

    // Helper: cell creator
    const c = (lbl, val) => `<div class="font-semibold">${lbl}</div><div class="cell-content">${escapeHtml(val)}</div>`;
    
    // Helper: Contact Relationship
    function getContactRel() {
        const rel = document.getElementById('contactRel')?.value;
        const other = document.getElementById('otherRelation')?.value;
        return rel === 'Other' ? (other || 'Other') : (rel || '');
    }

    // --- ROW 1: Contact ---
    const tr1 = document.createElement('tr');
    tr1.innerHTML = `
      <td width="15%">${c('DATE', document.getElementById('date').value)}</td>
      <td width="25%">${c('TAKEN BY', document.getElementById('takenBy').value)}</td>
      <td width="25%">${c('CONTACT NAME/SURNAME', document.getElementById('contactName').value)}</td>
      <td width="15%">${c('CONTACT PHONE #', document.getElementById('contactPhone').value)}</td>
      <td width="20%">${c('CONTACT RELATIONSHIP', getContactRel())}</td>
    `;
    tbl.appendChild(tr1);

    // --- ROW 2: Status & Immigration (WITH OTHER TEXT SUPPORT) ---
    const sStatus = getRadioValue('studentStatus');
    const sStatusTxt = sStatus === 'Other' ? (document.getElementById('studentStatusOther').value || 'Other') : sStatus;
    
    const imm = getRadioValue('immDoc');
    const immTxt = imm === 'Other' ? (document.getElementById('immDocOther').value || 'Other') : imm;
    
    const pAttend = getRadioValue('prevAttend');
    const pAttendTxt = pAttend === 'Yes' ? (checkboxMark(true) + ' Yes') : (pAttend === 'No' ? checkboxMark(true) + ' No' : '');

    const tr2 = document.createElement('tr');
    tr2.innerHTML = `
      <td>${c("STUDENT'S STATUS", sStatusTxt)}</td>
      <td>${c('IMMIGRATION DOCUMENT', immTxt)}</td>
      <td>${c('EXPIRY DATE', document.getElementById('expiry').value)}</td>
      <td>${c('PREVIOUS ATTENDANCE?', pAttendTxt)}</td>
      <td>${c('DATE LANDED', document.getElementById('landed').value)}</td>
    `;
    tbl.appendChild(tr2);

    // --- ROW 3: PARENTS ---
    const tr3 = document.createElement('tr');
    tr3.innerHTML = `
      <td colspan="5" class="no-padding">
        <table class="nested-table">
          <tr>
            <td width="25%">${c("FATHER'S SURNAME", document.getElementById('fatherSurname').value)}</td>
            <td width="25%">${c("FATHER'S GIVEN NAME", document.getElementById('fatherGiven').value)}</td>
            <td width="25%">${c("MOTHER'S SURNAME", document.getElementById('motherSurname').value)}</td>
            <td width="25%">${c("MOTHER'S GIVEN NAME", document.getElementById('motherGiven').value)}</td>
          </tr>
        </table>
      </td>
    `;
    tbl.appendChild(tr3);

    // --- ROW 4: ADDRESS ---
    const tr4 = document.createElement('tr');
    tr4.innerHTML = `
      <td colspan="5" class="no-padding">
        <table class="nested-table">
          <tr>
            <td width="20%">${c("APARTMENT #", document.getElementById('apt').value)}</td>
            <td width="60%">${c("FAMILY ADDRESS", document.getElementById('address').value)}</td>
            <td width="20%">${c("POSTAL CODE", document.getElementById('postal').value)}</td>
          </tr>
        </table>
      </td>
    `;
    tbl.appendChild(tr4);

    // --- ROW 5: INFO & HOME LANG FIX ---
    let homeLangs = '';
    const hlSelect = document.getElementById('homeLang');
    if (hlSelect.tomselect) {
        // TomSelect active
        const val = hlSelect.tomselect.getValue();
        homeLangs = Array.isArray(val) ? val.join(', ') : val;
    } else {
        // Standard Select fallback
        homeLangs = Array.from(hlSelect.selectedOptions).map(o=>o.value).join(', ');
    }
    
    const cathVal = getRadioValue('catholic');
    const relOther = document.getElementById('religionOther').value;
    const cathTxt = `${checkboxMark(cathVal==='Yes')} Yes  ${checkboxMark(cathVal==='No')} No` + (relOther ? `<br><strong>Note:</strong> ${escapeHtml(relOther)}` : '');

    const tr5 = document.createElement('tr');
    tr5.innerHTML = `
      <td colspan="5" class="no-padding">
        <table class="nested-table">
          <tr>
            <td width="33%">${c("FAMILY PHONE #", document.getElementById('familyPhone').value)}</td>
            <td width="34%">${c("HOME LANGUAGE", homeLangs)}</td>
            <td width="33%">${c("CATHOLIC", cathTxt)}</td>
          </tr>
        </table>
      </td>
    `;
    tbl.appendChild(tr5);

    // --- ROW 6: STUDENTS (WITH SEPARATOR LINES) ---
    // Widths: Surname 18%, Given 18%, Gender 8%, DOB 12%, Country 14%, Grade 10%, Year 10%, Prog 10%
    let stRows = '';
    
    for(let i=1; i<=studentCount; i++){
        const sn = document.getElementById(`s_${i}_surname`)?.value;
        
        // Skip empty rows if we have more than 1 student
        if(!sn && studentCount > 1) continue; 
        
        if(document.getElementById(`s_${i}_surname`)){
            const gn = document.getElementById(`s_${i}_given`).value;
            const dob = document.getElementById(`s_${i}_dob`).value;
            const birth = document.getElementById(`s_${i}_birth`).value;
            const gender = getRadioValue(`s_${i}_gender`);
            const year = getRadioValue(`s_${i}_year`) === 'ThisYear' ? 'This year' : 'Next year';
            
            // Program Logic
            let prog = '';
            const pt = getRadioValue(`s_${i}_progType`);
            if(pt === 'Regular') prog = 'Regular';
            else if(pt === 'Special') {
                const pd = document.getElementById(`s_${i}_prog_dropdown`).value;
                const ps = document.getElementById(`s_${i}_prog_spec`).value;
                prog = `Special - ${pd === 'Other' ? ps : pd}`;
            }

            // Grade Logic
            let grd = document.getElementById(`s_${i}_lastgrade`).value;
            if(grd === 'Other') grd = document.getElementById(`s_${i}_lastgrade_spec`).value;

            // Apply 'student-row' class for black line separation
            stRows += `<tr class="student-row">
                <td class="cell-content">${escapeHtml(sn)}</td>
                <td class="cell-content">${escapeHtml(gn)}</td>
                <td class="text-center">${checkboxMark(gender==='F')} F ${checkboxMark(gender==='M')} M</td>
                <td class="text-center cell-content">${escapeHtml(dob)}</td>
                <td class="cell-content">${escapeHtml(birth)}</td>
                <td class="text-center">${escapeHtml(grd)}</td>
                <td class="text-center">${year}</td>
                <td class="text-center cell-content">${escapeHtml(prog)}</td>
            </tr>`;
        }
    }

    const tr6 = document.createElement('tr');
    tr6.innerHTML = `
      <td colspan="5" class="no-padding">
        <table class="nested-table">
          <tr style="background-color:#fff8dc;"> <th width="18%">SURNAME</th>
             <th width="18%">GIVEN NAME</th>
             <th width="8%">GENDER</th>
             <th width="12%">DOB</th>
             <th width="14%">BIRTH COUNTRY</th>
             <th width="10%">LAST GRADE</th>
             <th width="10%">SCHOOL YEAR</th>
             <th width="10%">PROGRAM</th>
          </tr>
          ${stRows}
        </table>
      </td>
    `;
    tbl.appendChild(tr6);

    // --- ROW 7: LIMITED PROFILE (Overflow Fix) ---
    const lim = getRadioValue('limitedProfile');
    const limDet = document.getElementById('limitedProfileDetails').value;
    const tr7 = document.createElement('tr');
    tr7.innerHTML = `<td colspan="5">
        <div class="font-semibold">POTENTIAL LIMITED FORMAL SCHOOLING PROFILE</div>
        <div>${checkboxMark(lim==='Yes')} Yes  ${checkboxMark(lim==='No')} No</div>
        ${lim==='Yes' ? `<div class="cell-content" style="padding-left:20px;">${escapeHtml(limDet)}</div>` : ''}
    </td>`;
    tbl.appendChild(tr7);

    // --- ROW 8: NOTES (Overflow Fix) ---
    const notes = document.getElementById('notes').value;
    const tr8 = document.createElement('tr');
    tr8.innerHTML = `<td colspan="5">
        <div class="font-semibold">NOTES</div>
        <div class="cell-content" style="padding-left:20px;">${escapeHtml(notes)}</div>
    </td>`;
    tbl.appendChild(tr8);

    final.appendChild(tbl);
    
    // Switch Views
    document.getElementById('wizardRoot').classList.add('hidden');
    document.getElementById('finalWrap').classList.remove('hidden');
    window.scrollTo({top:0, behavior:'smooth'});
  }

  // ============================================
  // 5. INITIALIZATION
  // ============================================
  
  // Page 1 Select2
  $(document).ready(function() {
    $('#contactRel').select2({
      dropdownParent: $(document.body),
      dropdownPosition: 'below',
      width: '288px'
    });
  });

  // Home Language TomSelect
  const languages = ["English","Tigrinya","Amharic","Arabic","French","Spanish","Somali","Swahili","Hindi","Mandarin Chinese","Cantonese","Tagalog","Ukraine","Russian","Vietnamese","Other"];
  document.addEventListener('DOMContentLoaded', () => {
    const select = document.getElementById('homeLang');
    languages.forEach(lang => {
        const opt = document.createElement('option');
        opt.value = lang; opt.textContent = lang;
        select.appendChild(opt);
    });
    new TomSelect(select, {
        placeholder: "Select or type language(s)",
        maxOptions: 500, create: true, plugins: ['remove_button']
    });
  });

  // Buttons
  document.getElementById('editBtn').onclick = () => {
    document.getElementById('wizardRoot').classList.remove('hidden');
    document.getElementById('finalWrap').classList.add('hidden');
    window.scrollTo({top:0,behavior:'smooth'});
  }

  document.getElementById('pdfBtn').onclick = () => {
    const final = document.getElementById('finalArea');
    final.classList.add('pdf-scale');
    
    const opt = { 
        margin: 0.2, 
        filename: 'intake-form.pdf', 
        image: { type: 'jpeg', quality: 0.98 }, 
        html2canvas: { scale: 2, useCORS: true }, 
        jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' } 
    };
    
    html2pdf().set(opt).from(final).save().then(() => {
        final.classList.remove('pdf-scale');
    });
  };

  document.getElementById('newFormBtn').onclick = () => {
    if(!confirm("Start new form? Data will be lost.")) return;
    location.reload(); 
  };
</script>

<script>
/**
 * KEYBOARD NAVIGATION SCRIPT
 * - Arrows: Loop through fields.
 * - Shift+Arrows: Page Navigation.
 * - Enter: Selects/Opens Dropdowns.
 */
document.addEventListener('DOMContentLoaded', () => {

    // 1. Find all focusable elements
    function getFocusableElements(container) {
        if (!container) return [];
        const selector = 'input:not([type="hidden"]):not([disabled]), select:not([disabled]), textarea:not([disabled]), button:not([disabled]), a[href]';
        let elements = Array.from(container.querySelectorAll(selector));
        const select2Triggers = Array.from(container.querySelectorAll('.select2-selection'));
        const tomSelectInputs = Array.from(container.querySelectorAll('.ts-control input'));
        const allCandidates = [...elements, ...select2Triggers, ...tomSelectInputs];

        return allCandidates.filter(el => {
            if (el.closest('.nav-buttons')) return false;
            if (el.offsetParent === null) return false;
            if (el.tagName === 'SELECT' && (el.classList.contains('select2-hidden-accessible') || el.style.display === 'none')) return false;
            if (el.closest('.hidden')) return false;
            return true;
        }).sort((a, b) => {
            return (a.compareDocumentPosition(b) & Node.DOCUMENT_POSITION_FOLLOWING) ? -1 : 1;
        });
    }

    // 2. Main Key Handler
    document.addEventListener('keydown', function(event) {
        const currentStep = document.querySelector('.page:not(.hidden)');
        if (!currentStep) return;

        const activeEl = document.activeElement;
        const key = event.key;
        const isShift = event.shiftKey;

        // A. PAGE NAVIGATION (Shift + Left/Right)
        if (isShift && (key === 'ArrowLeft' || key === 'ArrowRight')) {
            event.preventDefault();
            const currentStepNum = parseInt(currentStep.dataset.step, 10);
            let nextStepNum = key === 'ArrowRight' ? currentStepNum + 1 : currentStepNum - 1;
            if (typeof goTo === 'function' && nextStepNum >= 1 && nextStepNum <= 6) {
                goTo(nextStepNum);
                setTimeout(() => {
                    const newPage = document.querySelector(`.page[data-step="${nextStepNum}"]`);
                    const focusables = getFocusableElements(newPage);
                    if (focusables[0]) focusables[0].focus();
                }, 50);
            }
            return;
        }

        // B. FIELD NAVIGATION (Arrows)
        if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(key)) {
            // Check dropdowns first
            const isSelect2Open = document.querySelector('.select2-container--open');
            const tsWrapper = activeEl.closest('.ts-wrapper');
            const isTomSelectOpen = tsWrapper && tsWrapper.classList.contains('input-active') && activeEl.closest('.ts-control');

            if (isSelect2Open || isTomSelectOpen) return; // Let library handle it

            // Text/Date Input boundaries
            const isTextLike = activeEl.tagName === 'INPUT' && ['text', 'password', 'email', 'tel', 'number', 'search', 'url'].includes(activeEl.type);
            const isTextArea = activeEl.tagName === 'TEXTAREA';
            
            if (isTextLike || isTextArea) {
                 try {
                    if (key === 'ArrowLeft' && activeEl.selectionStart > 0) return;
                    if (key === 'ArrowRight' && activeEl.selectionStart < activeEl.value.length) return;
                } catch (e) {}
            }
            if (activeEl.tagName === 'INPUT' && activeEl.type === 'date') {
                 if (key === 'ArrowLeft' || key === 'ArrowRight') return; 
            }

            // Loop Navigation
            event.preventDefault(); 
            const focusables = getFocusableElements(currentStep);
            if (focusables.length === 0) return;

            const idx = focusables.indexOf(activeEl);
            let nextIdx = idx;

            if (key === 'ArrowRight' || key === 'ArrowDown') {
                nextIdx = (idx + 1) % focusables.length;
            } else {
                nextIdx = (idx - 1 + focusables.length) % focusables.length;
            }

            if (focusables[nextIdx]) focusables[nextIdx].focus();
        }

        // C. SELECTION (Enter)
        if (key === 'Enter') {
            if (activeEl.tagName === "SELECT") return; 
            if (activeEl.tagName === 'TEXTAREA') return; // Allow new lines

            event.preventDefault(); 

            // Radio Toggle
            if (activeEl.type === 'radio') {
                if (activeEl.checked && activeEl.wasChecked) {
                    activeEl.checked = false;
                    activeEl.wasChecked = false;
                    if (activeEl.value === "Other") {
                        const target = activeEl.getAttribute("onchange")?.match(/'(.*?)'/)?.[1];
                        if (target) {
                            const input = document.getElementById(target);
                            input.classList.add("hidden");
                            input.value = "";
                        }
                    }
                    return;
                }
                document.querySelectorAll(`input[name="${activeEl.name}"]`).forEach(r => (r.wasChecked = false));
                activeEl.wasChecked = true;
                activeEl.checked = true;
                activeEl.dispatchEvent(new Event('change', { bubbles: true }));
                return;
            }

            // Trigger Buttons/Dropdowns
            if (activeEl.classList.contains('select2-selection')) { $(activeEl).trigger('click'); return; }
            if (activeEl.closest('.ts-control')) { activeEl.click(); return; }
            if (activeEl.tagName === 'BUTTON') { activeEl.click(); }
        }
      // --- D. GENERATE FORM SHORTCUT (Spacebar) ---
        if (key === ' ' && currentStep.dataset.step === '6') {
            // Do not execute if user is typing in a field
            const isTextType = activeEl.tagName === 'INPUT' && activeEl.type !== 'radio' && activeEl.type !== 'checkbox';
            if (isTextType || activeEl.tagName === 'TEXTAREA') {
                return; 
            }

            // Trigger the "Generate Yellow Form" button
            const generateBtn = document.querySelector('.page[data-step="6"] button:last-child');
            if (generateBtn && generateBtn.textContent.includes('Generate Yellow Form')) {
                event.preventDefault();
                generateBtn.click();
            }
        }
    });
});
</script>

</body>
</html>
